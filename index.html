<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TGN Party Boss Blitz Roster</title>
  <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/Booferu/TGN-Roster/refs/heads/main/favicon-16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/Booferu/TGN-Roster/refs/heads/main/favicon-32x32.png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /*  Dark theme colors */
      --bg-primary: #121212;
      --bg-secondary: #1e1e1e;
      --bg-tertiary: #252525;
      --accent-primary: #3d84f7;
      --accent-secondary: #ed4b9e;
      --accent-tertiary: #f2c94c;
      --text-primary: #ffffff;
      --text-secondary: #e0e0e0;
      --text-tertiary: #b0b0b0;
      --guild-color: #4ade80;
      --merc-color: #c084fc;
      --border-light: rgba(255, 255, 255, 0.1);
      --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.2);
      --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.3);
      --shadow-lg: 0 8px 16px rgba(0, 0, 0, 0.4);
      --grid-gap: 1.5rem;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --filled-glow: #e6973b;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 10% 20%, rgba(61, 132, 247, 0.05) 0%, transparent 20%),
        radial-gradient(circle at 90% 80%, rgba(237, 75, 158, 0.05) 0%, transparent 20%);
    }

    header {
      background-color: var(--bg-secondary);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 50;
      border-bottom: 1px solid var(--border-light);
    }

    .header-container {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-title {
      display: flex;
      align-items: center;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--text-primary);
      padding-left: 30px; /* Make space for icon */
      position: relative;
    }

    .header-title::before {
      content: "";
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      width: 24px;
      height: 24px;
      background-image: url('https://raw.githubusercontent.com/Booferu/TGN-Roster/refs/heads/main/favicon-32x32.png');
      background-size: contain;
      background-repeat: no-repeat;
      filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
    }
    
    .container {
      position: relative;
      z-index: 50;
      max-width: calc(1200px);
      margin: 2rem auto;
      padding: 2rem;
      background-color: rgba(30, 30, 30, 0.7);
      backdrop-filter: blur(10px);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    /* On smaller screens, restore full width */
    @media (max-width: 1200px) {
      .container {
        max-width: 1200px;
      }
    }

    .dragging {
      opacity: 0.6;
      background-color: var(--bg-tertiary);
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      color: var(--text-primary);
    }
    
    .description {
      text-align: center;
      max-width: 700px;
      margin: 0 auto 2rem;
      font-size: 1.1rem;
      color: var(--text-secondary);
      line-height: 1.7;
      padding: 1rem;
      background-color: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }
    
    .player-guild {
      color: var(--guild-color);
      font-weight: 500;
    }
    
    .player-merc {
      color: var(--merc-color);
      font-weight: 500;
    }
    
    nav {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    nav button {
      border: none;
      padding: 0.7rem 1.5rem;
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-weight: 600;
      color: var(--text-primary);
      font-family: inherit;
      transition: all 0.2s ease-in-out;
      font-size: 1rem;
      box-shadow: var(--shadow-sm);
    }
    
    #btn-normal { 
      background-color: #568ade;
    }

    #btn-hard { 
      background-color: #e44f4f;
    }

    #btn-rerun { 
      background-color: #e251a3;
      color: white;
    }

    nav button.active {
      transform: translateY(1px);
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0);
      outline: 2px solid rgba(255, 255, 255, 0.8);
    }

    nav button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
      filter: brightness(1.1);
    }
    
    .time-notice {
      text-align: center;
      margin: 0 auto 2rem;
      font-size: 0.95rem;
      color: #a0c4fe;
      font-style: italic;
      opacity: 0.8;
    }
    
    .roster {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: var(--grid-gap);
    }
    
    .group {
      background: var(--bg-secondary);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      padding: 1.5rem;
      transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
      border: 1px solid var(--border-light);
      position: relative;
      overflow: hidden;
    }
    
    .group::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
    }
    
    .group:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .group.filled {
      box-shadow: 0 0 10px 0 rgba(230, 151, 59, 0.35);
      border: 1px solid rgba(230, 151, 59, 0.3);
    }
    
    .group.filled::before {
      background: var(--filled-glow);
    }
    
    .group h2 {
      font-size: 1.3rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid var(--border-light);
      padding-bottom: 0.5rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .group.filled h2 {
      color: var(--filled-glow);
    }
    
    .player-list {
      list-style: none;
      padding: 0;
      margin-top: 1rem;
    }
    
    .player-list li {
      padding: 0.7rem 0.5rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: space-between;
      transition: background-color 0.2s ease;
    }
    
    .player-list li:hover {
      background-color: var(--bg-tertiary);
      border-radius: var(--radius-sm);
    }
    
    .player-list li:last-child {
      border-bottom: none;
    }
    
    .timezone {
      font-size: 1rem;
      margin-top: 0.5rem;
      color: var(--text-tertiary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .timezone::before {
      content: 'ðŸ•’';
      font-size: 0.9rem;
    }
    
    footer {
      text-align: center;
      margin-top: 3rem;
      font-size: 0.9rem;
      color: var(--text-tertiary);
      padding: 1rem 0;
      border-top: 1px solid var(--border-light);
    }
    
    .loading {
      text-align: center;
      padding: 3rem;
      font-size: 1.2rem;
      color: var(--text-secondary);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    
    .loading::after {
      content: '';
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-light);
      border-radius: 50%;
      border-top-color: var(--accent-primary);
      animation: loading 1s infinite linear;
    }
    
    @keyframes loading {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .last-updated {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: var(--text-tertiary);
      font-style: italic;
    }
    
    /* User panel styles */
    .user-panel {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background-color: var(--accent-primary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .user-actions {
      display: flex;
      gap: 0.8rem;
    }

    .btn {
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-family: inherit;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background-color: var(--accent-primary);
      color: white;
    }

    .btn-secondary {
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      border: 1px solid var(--border-light);
    }

    .btn-danger {
      background-color: #e44f4f;
      color: white;
    }

    .btn-success {
      background-color: var(--guild-color);
      color: black;
    }

    .btn:hover {
      filter: brightness(1.1);
      transform: translateY(-2px);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .join-btn {
      background-color: var(--accent-primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .join-btn:hover {
      filter: brightness(1.1);
    }

    .leave-btn {
      background-color: #e44f4f;
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 0.3rem 0.7rem;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .leave-btn:hover {
      filter: brightness(1.1);
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background-color: var(--bg-secondary);
      padding: 2rem;
      border-radius: var(--radius-md);
      width: 90%;
      max-width: 500px;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
    }

    .modal h3 {
      margin-bottom: 1.5rem;
      color: var(--text-primary);
      font-size: 1.5rem;
      text-align: center;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      color: var(--text-secondary);
    }

    .form-group input {
      width: 100%;
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      background-color: var(--bg-tertiary);
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      font-family: inherit;
    }

    .form-group input:focus {
      outline: 2px solid var(--accent-primary);
    }

    .form-actions {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      margin-top: 2rem;
    }

    .alert {
      padding: 0.8rem;
      border-radius: var(--radius-sm);
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .alert-error {
      background-color: rgba(228, 79, 79, 0.2);
      border: 1px solid rgba(228, 79, 79, 0.5);
      color: #f8b3b3;
    }

    .alert-success {
      background-color: rgba(74, 222, 128, 0.2);
      border: 1px solid rgba(74, 222, 128, 0.5);
      color: #b3f8c4;
    }

    /* Role badges */
    .role-badge {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 20px;
      font-size: 0.75rem;
      margin-left: 0.5rem;
      font-weight: 500;
    }

    .role-badge.admin {
      background-color: #f87171;
      color: white;
    }
	  
    .role-badge.guild-master {
      background-color: #f59e0b;
      color: black;
    }

    .role-badge.advisor {
      background-color: #8b5cf6;
      color: white;
    }

    .role-badge.staff {
      background-color: #ec4899;
      color: white;
    }

    .role-badge.officer {
      background-color: var(--accent-primary);
      color: white;
    }

    .role-badge.member {
      background-color: var(--guild-color);
      color: black;
    }

    .role-badge.mercenary {
      background-color: var(--merc-color);
      color: white;
    }

    /* Autocomplete Styles */
    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--bg-secondary);
      max-height: 250px;
      overflow-y: auto;
      border: 1px solid var(--border-light);
      border-top: none;
      border-radius: 0 0 var(--radius-sm) var(--radius-sm);
      z-index: 200;
      display: none;
      box-shadow: var(--shadow-md);
    }

    .autocomplete-option {
      padding: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      border-bottom: 1px solid var(--border-light);
    }

    .autocomplete-option:hover {
      background-color: var(--bg-tertiary);
    }

    .autocomplete-option:last-child {
      border-bottom: none;
    }

    /* Sidebar styles */
    #userSidebar {
      position: fixed;
      right: 20px;
      top: 103px;
      width: 280px;
      background-color: var(--bg-secondary);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-light);
      z-index: 40;
      max-height: calc(100vh - 140px);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 1rem;
      background-color: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-light);
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 60px;
    }

    .sidebar-header h3 {
      margin: 0;
      font-size: 1.2rem;
      color: var(--text-primary);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .sidebar-content {
      padding: 0.5rem;
      overflow-y: auto;
      flex-grow: 1;
      scrollbar-gutter: stable; /* Prevents content shift when scrollbar appears */
      padding-right: 4px; /* Add small padding to prevent scrollbar overlapping content */
    }

    .user-list-item {
      display: flex;
      align-items: center;
      padding: 0.8rem 1rem;
      margin: 0.3rem 0;
      border-radius: var(--radius-sm);
      background-color: var(--bg-tertiary);
      transition: background-color 0.2s ease;
    }

    .user-list-item:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .user-list-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 1rem;
      object-fit: cover;
    }

    .user-list-name {
      font-size: 1.1rem;
      color: var(--text-primary);
      flex-grow: 1;
    }

    .user-list-role {
      margin-left: 0.5rem;
    }

    /* Custom scrollbar for sidebar */
    .sidebar-content::-webkit-scrollbar {
      width: 8px;
    }

    .sidebar-content::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .sidebar-content::-webkit-scrollbar-thumb {
      background: var(--accent-primary);
      border-radius: 4px;
    }

    .sidebar-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }

    /* For Firefox */
    .sidebar-content {
      scrollbar-width: thin;
      scrollbar-color: var(--accent-primary) var(--bg-tertiary);
    }

    /* Drop target highlighting */
    .player-list li.highlight-drop {
      background-color: rgba(61, 132, 247, 0.5) !important;
      transform: scale(1.02);
      transition: all 0.2s ease;
    }

    .player-list li[draggable="true"] {
      cursor: grab;
    }
    .player-list li[draggable="true"]:active {
      cursor: grabbing;
    }

    /* Draggable user items */
    .user-list-item[draggable="true"] {
      cursor: grab;
    }

    .user-list-item[draggable="true"]:active {
      cursor: grabbing;
    }

    /* Hide sidebar on mobile */
    @media (max-width: 1200px) {
      #userSidebar {
        display: none;
      }
    }
	  
    /* For small devices */
    @media (max-width: 768px) {
      body {
        padding: 0;
      }
      
      .container {
        padding: 1rem;
        margin: 1rem auto;
        border-radius: 0;
      }
      
      header {
        padding: 1rem;
      }
      
      h1 {
        font-size: 1.8rem;
      }
      
      .description {
        font-size: 0.95rem;
      }
      
      nav button {
        padding: 0.6rem 1rem;
        font-size: 0.9rem;
      }
      
      .roster {
        grid-template-columns: 1fr;
      }
      
      .user-panel {
        flex-direction: column;
        align-items: flex-end;
        gap: 0.5rem;
      }
      
      .user-actions {
        width: 100%;
        justify-content: flex-end;
      }
      img[alt][src*="badges/"] {
        border-radius: 2px;
        vertical-align: middle;
      }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
</head>
<body>
  <div id="userSidebar">
    <div class="sidebar-header">
      <h3>Users</h3>
    </div>
    <div class="sidebar-content" id="userList">
      <div class="loading">Loading users...</div>
    </div>
  </div>
  <header>
    <div class="header-container">
      <div class="header-title">TGN</div>
      <div class="user-panel" id="userPanel">
        <!-- Content will be dynamically generated -->
      </div>
    </div>
  </header>

  <div class="container">
    <h1>TGN Party Boss Blitz Roster</h1>
    
    <div class="description">
      This page organizes static groups for the weekly <strong>Party Boss Blitz</strong> content.<br>
      <strong><span class="player-guild">Guild members (âœ”)</span> have priority</strong>. <span class="player-merc">Mercenaries (âœ¦)</span> are welcome to fill in but may be replaced if a guild member signs up.
    </div>
    
    <nav>
      <button onclick="setSection('normal')" id="btn-normal" class="active">Normal Mode</button>
      <button onclick="setSection('hard')" id="btn-hard">Hard Mode</button>
      <button onclick="setSection('rerun')" id="btn-rerun">Re-runs / Fill-ins</button>
    </nav>
	  
    <div class="time-notice">Times are displayed in your local time zone</div>
	  
    <div class="roster" id="roster">
      <div class="loading">Loading roster data...</div>
    </div>
    
    <div class="last-updated" id="lastUpdated"></div>
    
    <footer>
      Powered by TGN &middot; User Managed Roster
    </footer>
  </div>

  <!-- Login Modal -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h3>Login</h3>
      <div id="loginAlert" class="alert alert-error" style="display: none;"></div>
      <div class="form-group">
        <label for="loginUsername">Username</label>
        <input type="text" id="loginUsername" placeholder="Enter your character name">
      </div>
      <div class="form-group">
        <label for="loginPassword">Password</label>
        <input type="password" id="loginPassword" placeholder="Enter your password">
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('loginModal')">Cancel</button>
        <button class="btn btn-primary" id="loginSubmitBtn">Login</button>
      </div>
      <p style="text-align: center; margin-top: 1rem; color: var(--text-tertiary);">
        Don't have an account? <a href="#" onclick="openModal('registerModal'); closeModal('loginModal');" style="color: var(--accent-primary);">Register</a>
      </p>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal" id="registerModal">
    <div class="modal-content">
      <h3>Register</h3>
      <div id="registerAlert" class="alert alert-error" style="display: none;"></div>
      <div class="form-group">
        <label for="registerUsername">Character Name</label>
        <input type="text" id="registerUsername" placeholder="Enter your character name">
      </div>
      <div class="form-group">
        <label for="registerPassword">Password</label>
        <input type="password" id="registerPassword" placeholder="Create a password">
      </div>
      <div class="form-group">
        <label for="registerConfirmPassword">Confirm Password</label>
        <input type="password" id="registerConfirmPassword" placeholder="Confirm your password">
      </div>
      <div class="form-group">
        <label for="registerRole">Role</label>
        <select id="registerRole" style="width: 100%; padding: 0.8rem; border-radius: var(--radius-sm); background-color: var(--bg-tertiary); border: 1px solid var(--border-light); color: var(--text-primary); font-family: inherit;">
          <option value="member">Guild Member</option>
          <option value="mercenary">Mercenary</option>
        </select>
      </div>
      <div class="form-group" id="officerCodeGroup" style="display: none;">
        <label for="officerCode">Officer Code</label>
        <input type="password" id="officerCode" placeholder="Enter officer access code">
        <small style="color: var(--text-tertiary); display: block; margin-top: 0.5rem;">
          Only required for officer roles. Ask your guild leader for the code.
        </small>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('registerModal')">Cancel</button>
        <button class="btn btn-primary" id="registerSubmitBtn">Register</button>
      </div>
      <p style="text-align: center; margin-top: 1rem; color: var(--text-tertiary);">
        Already have an account? <a href="#" onclick="openModal('loginModal'); closeModal('registerModal');" style="color: var(--accent-primary);">Login</a>
      </p>
    </div>
  </div>

  <!-- Admin Panel Modal -->
  <div class="modal" id="adminModal">
    <div class="modal-content">
      <h3>Admin Panel</h3>
      <div id="adminAlert" class="alert" style="display: none;"></div>
      
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Role Management</h4>
        <div class="form-group">
          <label for="adminUsername">Username</label>
	  <div class="autocomplete-wrapper">
	    <input type="text" id="adminUsername" placeholder="Enter username to modify" autocomplete="off">
	    <div id="userSuggestions" class="autocomplete-results"></div>
	  </div>
        </div>
        <div class="form-group">
          <label for="adminRole">New Role</label>
          <select id="adminRole" style="width: 100%; padding: 0.8rem; border-radius: var(--radius-sm); background-color: var(--bg-tertiary); border: 1px solid var(--border-light); color: var(--text-primary); font-family: inherit;">
            <option value="member">Member</option>
            <option value="mercenary">Mercenary</option>
            <option value="officer">Officer</option>
            <option value="staff">Staff</option>
            <option value="advisor">Advisor</option>
            <option value="guild-master">Guild Master</option>
          </select>
        </div>
        <button class="btn btn-primary" id="updateRoleBtn" style="margin-top: 0.5rem;">Update Role</button>
      </div>
      
      <div style="margin-bottom: 1.5rem;">
        <h4 style="margin-bottom: 0.5rem; color: var(--text-secondary);">Roster Management</h4>
        <button class="btn btn-danger" id="resetRosterBtn">Reset Roster</button>
        <button class="btn btn-secondary" id="exportRosterBtn" style="margin-left: 0.5rem;">Export Roster</button>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('adminModal')">Close</button>
      </div>
    </div>
  </div>

  <!-- Edit Group Modal -->
  <div class="modal" id="editGroupModal">
    <div class="modal-content">
      <h3>Edit Group</h3>
      <div id="editGroupAlert" class="alert" style="display: none;"></div>
      
      <div class="form-group">
        <label for="editGroupName">Group Name</label>
        <input type="text" id="editGroupName" placeholder="Group name">
      </div>
      
      <div class="form-group">
        <label for="editGroupTime">Time (UTC)</label>
        <input type="text" id="editGroupTime" placeholder="Example: 20:00">
      </div>

      <div class="form-group">
        <label for="editGroupDate">Date or Day (e.g. Friday or 2025-04-27)</label>
        <input type="text" id="editGroupDate" placeholder="e.g. Friday or 2025-04-27">
      </div>
      
      <div class="form-group">
        <label>Group Members</label>
        <div id="editGroupMembers">
          <!-- Dynamically generated member list -->
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="closeModal('editGroupModal')">Cancel</button>
        <button class="btn btn-primary" id="saveGroupChangesBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <script>
    // Current active section
    let currentSection = 'normal';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyANFiNgI5AElip2yg1s1j8X_C_fySX0b38",
      authDomain: "tgn-roster.firebaseapp.com",
      projectId: "tgn-roster",
      storageBucket: "tgn-roster.appspot.com",
      messagingSenderId: "680550686349",
      appId: "1:680550686349:web:bf8d53910264c3a5004cc4",
      measurementId: "G-CN0HQ0HH8K",
      databaseURL: "https://tgn-roster-default-rtdb.firebaseio.com"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    const auth = firebase.auth();

    const IMGUR_CLIENT_ID = '39f8c230782d6da'; // Replace with Client ID from Imgur

    async function uploadToImgur(file) {
      if (!file || !currentUser) return;

      const formData = new FormData();
      formData.append("image", file);

      try {
        const response = await fetch("https://api.imgur.com/3/image", {
          method: "POST",
         headers: {
            Authorization: `Client-ID ${IMGUR_CLIENT_ID}`
          },
          body: formData
        });

        const data = await response.json();

        if (!data.success) {
          alert("Failed to upload image");
          return;
        }

        const imageUrl = data.data.link;

        // Save URL in Firebase
        await firebase.database().ref(`users/${currentUser.uid}/photoURL`).set(imageUrl);
        alert("Profile picture uploaded!");
        location.reload(); // Refresh to show new avatar
      } catch (error) {
        console.error("Imgur upload error:", error);
        alert("Error uploading image");
      }
    }


    // Store the fetched data
    const allData = {
      normal: [],
      hard: [],
      reruns: []
    };

    function getActualSection(sectionName) {
      return sectionName === 'rerun' ? 'reruns' : sectionName;
    }

    // Store authenticated user info
    let currentUser = null;

    // Load all profile photos once when the page starts
    async function loadAllUserPhotos() {
      const snapshot = await database.ref('users').once('value');
      const users = snapshot.val() || {};
      window.allUserPhotos = {};
      window.allUserRoles = {};

      for (const uid in users) {
        const user = users[uid];
        if (user.username && user.photoURL) {
          window.allUserPhotos[user.username] = user.photoURL;
        }
	window.allUserRoles[user.username] = user.role;
      }
    }

    // Helper function to load all suggestions
    function loadAllSuggestions(container, input) {
      const allUsers = Object.keys(window.allUserRoles || {})
	.sort((a, b) => a.localeCompare(b))
        .slice(0, 50); // limit to 50 results
      showSuggestions(allUsers, container, input);
    }

    // Helper function to filter suggestions
    function filterSuggestions(search, container, input) {
      if (search === '') {
        loadAllSuggestions(container, input);
        return;
      }

      const matchedUsers = Object.keys(window.allUserRoles || {})
        .filter(name => name.toLowerCase().includes(search))
	.sort((a, b) => a.localeCompare(b))
        .slice(0, 50); // limit to 50 results

      showSuggestions(matchedUsers, container, input);
    }

    // Helper function to display suggestions
    function showSuggestions(users, container, input) {
      container.innerHTML = '';
  
      if (users.length === 0) {
        container.style.display = 'none';
        return;
      }

      users.forEach(name => {
        const avatar = window.allUserPhotos[name] || null;
        const role = window.allUserRoles[name] || 'member';
        const option = document.createElement('div');
        option.className = 'autocomplete-option';
        option.innerHTML = `
          ${avatar ? `<img src="${avatar}" style="width: 24px; height: 24px; border-radius: 50%;">` : ''}
          <strong>${name}</strong>
          <span class="role-badge ${role}" style="margin-left: auto;">${role.replace('-', ' ')}</span>
        `;
        option.addEventListener("click", () => {
          input.value = name;
          container.style.display = 'none';
        });
        container.appendChild(option);
      });
  
      container.style.display = 'block';
    }

    function setupAdminAutocomplete() {
      const input = document.getElementById("adminUsername");
      const suggestionsBox = document.getElementById("userSuggestions");

      if (!input || !suggestionsBox) return;

      // Clear previous event listeners to avoid duplicates
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      const newSuggestionsBox = suggestionsBox.cloneNode(true);
      suggestionsBox.parentNode.replaceChild(newSuggestionsBox, suggestionsBox);

      // Get fresh references
      const freshInput = document.getElementById("adminUsername");
      const freshSuggestionsBox = document.getElementById("userSuggestions");

      // Only show suggestions when input is focused/clicked
      freshInput.addEventListener("focus", function() {
        loadAllSuggestions(freshSuggestionsBox, freshInput);
        freshSuggestionsBox.style.display = 'block';
      });

      // Handle input typing
      freshInput.addEventListener("input", function() {
        const search = freshInput.value.toLowerCase().trim();
        filterSuggestions(search, freshSuggestionsBox, freshInput);
      });

      // Hide suggestions when clicking outside
      document.addEventListener("click", function(e) {
        if (!freshInput.contains(e.target) && !freshSuggestionsBox.contains(e.target)) {
          freshSuggestionsBox.style.display = 'none';
        }
      });
    }
    
    // Initialize the app
	async function init() {
	  // Set up Firebase auth state listener
	  auth.onAuthStateChanged(async user => {
	    if (user) {
	      try {
	        const userData = await getUserData(user.uid);
	        
	        if (!userData) {
	          // User document doesn't exist - this shouldn't normally happen
	          console.error('User data not found for UID:', user.uid);
	          await auth.signOut(); // Force logout since data is missing
	          return;
	        }
	        
	        currentUser = {
	          uid: user.uid,
	          username: userData.username || 'Unknown',
	          role: userData.role || 'member',
	          photoURL: userData.photoURL || null
	        };
	        updateUserPanel();
		await loadAllUsers();
	      } catch (error) {
	        console.error('Error loading user data:', error);
	        currentUser = null;
	        updateUserPanel();
	      }
	    } else {
	      // User is signed out
	      currentUser = null;
	      updateUserPanel();
	      await loadAllUsers();
	    }
	  });
	  
	  // Set up event listeners
	  document.getElementById('loginSubmitBtn').addEventListener('click', handleLogin);
	  document.getElementById('registerSubmitBtn').addEventListener('click', handleRegister);
	  
	  // Register role selection
	  document.getElementById('registerRole').addEventListener('change', function() {
	    const officerCodeGroup = document.getElementById('officerCodeGroup');
	    if (this.value === 'officer') {
	      officerCodeGroup.style.display = 'block';
	    } else {
	      officerCodeGroup.style.display = 'none';
	    }
	  });
	  
	  // Admin panel functionality
	  document.getElementById('updateRoleBtn').addEventListener('click', updateUserRole);
	  document.getElementById('resetRosterBtn').addEventListener('click', resetRoster);
	  document.getElementById('exportRosterBtn').addEventListener('click', exportRoster);
	  
	  try {
	    await initializeDatabase();
	    await loadAllUserPhotos();
	    setupAdminAutocomplete();
	    await loadAllUsers();
	    await fetchAllData();
	  } catch (error) {
	    console.error("Initialization error:", error);
	    document.getElementById('roster').innerHTML = `<div class="loading">Error initializing application: ${error.message}</div>`;
	  }
	}

	// Initialize the database with default structure if empty
	async function initializeDatabase() {
	  try {
		const snapshot = await database.ref('roster').once('value');
		if (!snapshot.exists()) {
		  console.log('Creating initial database structure');
		  // Default empty structure
		  const defaultData = {
		    normal: Array.from({ length: 10 }, (_, i) => ({
			  group: `Normal Group ${i + 1}`,
			  timeUTC: i % 2 === 0 ? "20:00" : "22:00",
			  players: ["", "", "", "", ""]
		    })),
		    hard: Array.from({ length: 10 }, (_, i) => ({
			  group: `Hard Group ${i + 1}`,
			  timeUTC: i % 2 === 0 ? "19:00" : "21:00",
			  players: ["", "", "", "", ""]
		    })),
		    reruns: Array.from({ length: 10 }, (_, i) => ({
			  group: `Rerun Group ${i + 1}`,
			  timeUTC: i % 2 === 0 ? "18:00" : "23:00",
			  players: ["", "", "", "", ""]
		    }))
		  };
		  
		  await database.ref('roster').set(defaultData);
		  console.log('Database initialized with default structure');
		}
	  } catch (error) {
		console.error('Error initializing database:', error);
		throw error; // Re-throw to be caught by the calling function
	  }
	}
	
    // =====================
    // User Authentication
    // =====================
    
    // Get user data from Firebase
    async function getUserData(uid) {
      const snapshot = await database.ref(`users/${uid}`).once('value');
      return snapshot.val();
    }
    
    // Update the user panel based on login status
    function updateUserPanel() {
      const panel = document.getElementById('userPanel');
      
      if (currentUser) {
        // User is logged in
        let roleBadge = '';
	if (currentUser.role === 'admin') {
	  roleBadge = '<span class="role-badge admin">Admin</span>';
	}
        if (currentUser.role === 'guild-master') {
          roleBadge = '<span class="role-badge guild-master">Guild Master</span>';
        } else if (currentUser.role === 'advisor') {
          roleBadge = '<span class="role-badge advisor">Advisor</span>';
        } else if (currentUser.role === 'staff') {
          roleBadge = '<span class="role-badge staff">Staff</span>';
        } else if (currentUser.role === 'officer') {
          roleBadge = '<span class="role-badge officer">Officer</span>';
        } else if (currentUser.role === 'member') {
          roleBadge = '<span class="role-badge member">Member</span>';
        } else if (currentUser.role === 'mercenary') {
          roleBadge = '<span class="role-badge mercenary">Mercenary</span>';
        }
        
	panel.innerHTML = `
	  <div class="user-info">
	    <div class="user-avatar" style="background: none; padding: 0;">
	      ${currentUser.photoURL ? `<img src="${currentUser.photoURL}" alt="avatar" style="width:32px;height:32px;border-radius:50%;">` : currentUser.username.charAt(0).toUpperCase()}
	    </div>
	    <div>
	      <span>${currentUser.username}</span>
	      ${roleBadge}
	    </div>
	  </div>
	  <div class="user-actions">
	    <input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="uploadToImgur(this.files[0])" />
	    <button class="btn btn-secondary" onclick="document.getElementById('profilePicInput').click()">Upload Profile Picture</button>
	    ${['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role) ? 
	      `<button class="btn btn-secondary" onclick="openModal('adminModal')">Admin Panel</button>` : ''}
	    <button class="btn btn-danger" onclick="handleLogout()">Logout</button>
	  </div>
	`;
      } else {
        // User is not logged in
        panel.innerHTML = `
          <div class="user-info">
            <span>Not logged in</span>
          </div>
          <div class="user-actions">
            <button class="btn btn-secondary" onclick="openModal('registerModal')">Register</button>
            <button class="btn btn-primary" onclick="openModal('loginModal')">Login</button>
          </div>
        `;
      }
    }
    
    // Handle login form submission
    async function handleLogin() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      const alertElement = document.getElementById('loginAlert');
      
      if (!username || !password) {
        showAlert(alertElement, 'Please enter both username and password', 'error');
        return;
      }
      
      try {
        // Find user by username
        const usersSnapshot = await database.ref('usernames').once('value');
        const users = usersSnapshot.val() || {};
        
        if (!users[username]) {
          showAlert(alertElement, 'User not found', 'error');
          return;
        }
        
        const uid = users[username];
        
        // Sign in with email/password (using the UID as email for simplicity)
        await auth.signInWithEmailAndPassword(`${username.toLowerCase()}@tgn.com`, password);
        
        // Login successful - the auth state listener will handle the rest
        closeModal('loginModal');
        
        // Clear form
        document.getElementById('loginUsername').value = '';
        document.getElementById('loginPassword').value = '';
      } catch (error) {
        console.error('Login error:', error);
        showAlert(alertElement, error.message, 'error');
      }
    }
    
    // Handle registration form submission
    async function handleRegister() {
      const username = document.getElementById('registerUsername').value.trim();
      const password = document.getElementById('registerPassword').value.trim();
      const confirmPassword = document.getElementById('registerConfirmPassword').value.trim();
      const role = document.getElementById('registerRole').value;
      const officerCode = document.getElementById('officerCode').value.trim();
      const alertElement = document.getElementById('registerAlert');

      if (!username || !password || !confirmPassword) {
        showAlert(alertElement, 'Please fill in all fields', 'error');
        return;
      }

      if (password !== confirmPassword) {
        showAlert(alertElement, 'Passwords do not match', 'error');
        return;
      }

      if (password.length < 6) {
        showAlert(alertElement, 'Password must be at least 6 characters', 'error');
        return;
      }

      try {
        // Check username availability first
        const usernamesSnapshot = await database.ref('usernames').once('value');
        const usernames = usernamesSnapshot.val() || {};

        if (usernames[username]) {
          showAlert(alertElement, 'Username already exists', 'error');
          return;
        }

        // Check officer code if registering as officer
        let finalRole = role;
        if (role === 'officer') {
          const settingsSnapshot = await database.ref('settings').once('value');
          const settings = settingsSnapshot.val() || {};
          if (officerCode !== settings.officerCode) {
            showAlert(alertElement, 'Invalid officer code', 'error');
            return;
          }
        }

        // Create auth user
        const fakeEmail = `${username.toLowerCase()}@tgn.com`;
        const userCredential = await auth.createUserWithEmailAndPassword(fakeEmail, password);
        const uid = userCredential.user.uid;

        // Save user to database
        await database.ref(`users/${uid}`).set({
          username: username,
          role: finalRole
        });

        // Create username mapping
        await database.ref(`usernames/${username}`).set(uid);

        // Close modal and reset form
        closeModal('registerModal');
        document.getElementById('registerUsername').value = '';
        document.getElementById('registerPassword').value = '';
        document.getElementById('registerConfirmPassword').value = '';
        document.getElementById('registerRole').value = 'member';
        document.getElementById('officerCode').value = '';

      } catch (error) {
        console.error('Registration error:', error);
        
        // Special handling for username conflicts
        if (error.code === 'PERMISSION_DENIED' && error.message.includes('usernames')) {
          showAlert(alertElement, 'Username is already taken', 'error');
        } 
        // Handle email already in use (if someone registered the same username before)
        else if (error.code === 'auth/email-already-in-use') {
          showAlert(alertElement, 'Username is already registered', 'error');
        }
        else {
          showAlert(alertElement, error.message, 'error');
        }
      }
    }
    
    // Generate a simple UID
    function generateUid() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    // Handle logout
    function handleLogout() {
      auth.signOut();
    }
    
    // Update user role (admin function)
    async function updateUserRole() {
      const username = document.getElementById('adminUsername').value.trim();
      const newRole = document.getElementById('adminRole').value;
      const alertElement = document.getElementById('adminAlert');
  
      if (!username) {
        showAlert(alertElement, 'Please enter a username', 'error');
        return;
      }

      try {
        // Find user by username
        const usernamesSnapshot = await database.ref('usernames').once('value');
        const usernames = usernamesSnapshot.val() || {};
    
        if (!usernames[username]) {
          showAlert(alertElement, 'User not found', 'error');
          return;
        }
    
        const uid = usernames[username];

	// Prevent users from promoting themselves
	if (uid === currentUser.uid && newRole !== currentUser.role) {
	  showAlert(alertElement, 'You cannot change your own role', 'error');
	  return;
	}
	      
        const targetUserRef = database.ref(`users/${uid}`);
        const targetUserSnapshot = await targetUserRef.once('value');
        const targetUser = targetUserSnapshot.val();
    
        // Define assignable roles for each rank
        const assignableRoles = {
          'admin': ['admin', 'guild-master', 'advisor', 'staff', 'officer', 'member', 'mercenary'],
          'guild-master': ['guild-master', 'advisor', 'staff', 'officer', 'member', 'mercenary'],
          'advisor': ['advisor', 'staff', 'officer', 'member', 'mercenary'],
          'staff': ['staff', 'officer', 'member', 'mercenary'],
          'officer': ['officer', 'member', 'mercenary'],
          'member': [],
          'mercenary': []
        };
    
        // Check if current user can assign this role
        if (!assignableRoles[currentUser.role]?.includes(newRole)) {
          showAlert(alertElement, `You cannot assign the ${newRole} role`, 'error');
          return;
        }
    
        // Special case: Only admin can modify other admins
        if (targetUser.role === 'admin' && currentUser.role !== 'admin') {
          showAlert(alertElement, 'Only admin can modify other admins', 'error');
          return;
        }
    
        // Update role
        await targetUserRef.update({ role: newRole });
    
        showAlert(alertElement, `Changed ${username} to ${newRole}`, 'success');
        document.getElementById('adminUsername').value = '';
      } catch (error) {
        console.error('Role update failed:', error);
        showAlert(alertElement, error.message, 'error');
      }
    }
    
    // =====================
    // Roster Management
    // =====================

    function getRoleBadgeImage(role) {
      const base = "https://raw.githubusercontent.com/Booferu/TGN-Roster/refs/heads/main/Badges";
      const badges = {
        "admin": "admin.png",
        "guild-master": "guild-master.png",
        "advisor": "advisor.png",
        "staff": "staff.png",
        "officer": "officer.png"
      };
      return badges[role] ? `${base}/${badges[role]}` : null;
    }
	  
    // Function to determine if a player is a guild member or mercenary
    function getPlayerType(name) {
      if (!name) return 'none';
      if (name.includes('âœ”')) return 'guild';
      if (name.includes('âœ¦')) return 'merc';
      return 'none';
    }

    // Function to clean up player name by removing symbols
    function cleanPlayerName(name) {
      if (!name) return '';
      return name.replace('âœ”', '').replace('âœ¦', '').trim();
    }

    // Function to convert UTC time to local time
    function convertUTCToLocal(utcTimeStr) {
      if (!utcTimeStr) return 'No time specified';
      
      try {
        if (utcTimeStr.toLowerCase() === 'tbd' || utcTimeStr.toLowerCase() === 'n/a') {
          return utcTimeStr;
        }
        
        const timeParts = utcTimeStr.trim().split(':');
        if (timeParts.length !== 2) {
          return utcTimeStr;
        }
        
        const hours = parseInt(timeParts[0], 10);
        const minutes = parseInt(timeParts[1], 10);
        
        if (isNaN(hours) || isNaN(minutes)) {
          return utcTimeStr;
        }
        
        const utcDate = new Date();
        utcDate.setUTCHours(hours, minutes, 0, 0);
        
        const localTimeStr = utcDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        return `${localTimeStr} (${utcTimeStr} UTC)`;
      } catch (error) {
        console.error("Error converting time:", error);
        return utcTimeStr;
      }
    }

    // Function to check if a group is filled (has all 5 players)
    function isGroupFilled(players) {
      if (!Array.isArray(players)) return false;
      
      let filledSlots = 0;
      for (let i = 0; i < players.length; i++) {
        if (players[i] && players[i].trim() !== '') {
          filledSlots++;
        }
      }
      
      return filledSlots === 5;
    }

    // Function to check if current user can join a group
    function canJoinGroup(groupData) {
      if (!currentUser) return false;
      
      // Admins and officers can always edit
      if (['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) return true;
      
      const processedPlayers = processPlayers(groupData.players || []);
      
      // Check if user is already in the group
      const isAlreadyInGroup = processedPlayers.some(p => p.name === currentUser.username);
      if (isAlreadyInGroup) return false;
      
      // Check if group is full
      if (isGroupFilled(groupData.players)) return false;
      
      return true;
    }

    // Function to check if current user can leave a group
    function canLeaveGroup(groupData) {
      if (!currentUser) return false;
      
      const processedPlayers = processPlayers(groupData.players || []);
      
      // Check if user is in the group
      return processedPlayers.some(p => p.name === currentUser.username);
    }

    // Function to process player data
    function processPlayers(players) {
      if (!Array.isArray(players)) {
        console.error("Expected players to be an array, got:", players);
        return [];
      }
      return players.map(player => {
        return {
          name: cleanPlayerName(player),
          type: getPlayerType(player)
        };
      });
    }

    // Function to join a group
    async function joinGroup(sectionName, groupIndex) {
      if (!currentUser) {
        openModal('loginModal');
        return;
      }
      
      renderGroups(allData[getActualSection(sectionName)]);
      const group = allData[getActualSection(sectionName)][groupIndex];
      if (!group) return;
      
      // Find an empty slot
      let emptySlotIndex = -1;
      for (let i = 0; i < (group.players || []).length; i++) {
        if (!group.players[i] || group.players[i].trim() === '') {
          emptySlotIndex = i;
          break;
        }
      }
      
      if (emptySlotIndex === -1 && group.players.length < 5) {
        emptySlotIndex = group.players.length;
      }
      
      if (emptySlotIndex === -1) {
        alert('No empty slots available');
        return;
      }
      
      // Add user to the group with appropriate symbol
      const symbol = currentUser.role === 'mercenary' ? 'âœ¦ ' : 'âœ” ';
      group.players[emptySlotIndex] = symbol + currentUser.username;
      
      // Save to Firebase
      // Save to Firebase
	  const sectionPath = getActualSection(sectionName);
	  await database.ref(`roster/${sectionPath}/${groupIndex}`).set(group);
      
      // Re-render the roster
	  renderGroups(allData[getActualSection(sectionName)]);
    }

      // Function to leave a group
      async function leaveGroup(sectionName, groupIndex) {
        if (!currentUser) return;

        const sectionKey = getActualSection(sectionName);
        const group = allData[sectionKey][groupIndex];
        if (!group) return;

      // Find the user in the group
        let userSlotIndex = -1;
        for (let i = 0; i < (group.players || []).length; i++) {
          if (group.players[i] && cleanPlayerName(group.players[i]) === currentUser.username) {
            userSlotIndex = i;
            break;
          }
        }

        if (userSlotIndex === -1) return;

      // Remove the user
        group.players[userSlotIndex] = '';

      // Clean up gaps
        group.players = group.players.filter(p => p && p.trim() !== '');
        while (group.players.length < 5) {
          group.players.push('');
        }

      // Save to Firebase
        await database.ref(`roster/${sectionKey}/${groupIndex}`).set(group);

      // âœ… NOW re-render
        renderGroups(allData[sectionKey]);
      }

    // Reset roster (admin function)
    async function resetRoster() {
      if (!currentUser || !['guild-master', 'advisor', 'staff'].includes(currentUser.role)) {
        return;
      }
      
      if (!confirm("Are you sure you want to reset the roster? This will clear all current data.")) {
        return;
      }
      
      // Create empty structure
      const emptyData = {
        normal: [],
        hard: [],
        reruns: []
      };
      
      // Save to Firebase
      await database.ref('roster').set(emptyData);
      
      // Update the UI
      allData.normal = emptyData.normal;
      allData.hard = emptyData.hard;
      allData.reruns = emptyData.reruns;
      
      // Reset UI
      renderGroups(allData[currentSection]);
      
      const alertElement = document.getElementById('adminAlert');
      showAlert(alertElement, 'Roster has been reset', 'success');
    }

    // Export roster data
    function exportRoster() {
      const dataStr = JSON.stringify(allData, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportFileDefaultName = 'tgn_roster.json';
      
      let linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportFileDefaultName);
      linkElement.click();
    }

    // =====================
    // UI Helpers
    // =====================
    
    // Open modal
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('show');
    }
    
    // Close modal
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('show');
      
      // Clear alerts
      const alertElement = document.getElementById(`${modalId.replace('Modal', '')}Alert`);
      if (alertElement) {
        alertElement.style.display = 'none';
      }

      // Reset autocomplete specifically for admin modal
      if (modalId === 'adminModal') {
        const suggestionsBox = document.getElementById("userSuggestions");
        if (suggestionsBox) {
          suggestionsBox.innerHTML = '';
          suggestionsBox.style.display = 'none';
        }
        const usernameInput = document.getElementById("adminUsername");
        if (usernameInput) {
          usernameInput.value = '';
        }
      }	    
    }
    
    // Show alert message
    function showAlert(element, message, type = 'error') {
      element.textContent = message;
      element.className = `alert alert-${type}`;
      element.style.display = 'block';
      
      // Auto-hide after 5 seconds
      setTimeout(() => {
        element.style.display = 'none';
      }, 5000);
    }
    
    // Function to render groups
    function renderGroups(data) {
      const container = document.getElementById('roster');
      container.innerHTML = '';
  
      if (!data || data.length === 0) {
        container.innerHTML = '<div class="loading">No data available for this section.</div>';
        return;
      }
  
      data.forEach((group, groupIndex) => {
        const div = document.createElement('div');
        div.className = 'group';
    
        if (isGroupFilled(group.players)) {
          div.classList.add('filled');
        }
    
        let playerListHTML = '';
        const processedPlayers = processPlayers(group.players || []);

        // Make sure we always show 5 slots
        for (let i = 0; i < 5; i++) {
          const player = processedPlayers[i] || null;
      
          if (player && player.name) {
            // Player slot with the option to leave if it's the current user
            const isCurrentUser = currentUser && player.name === currentUser.username;
            const leaveButton = isCurrentUser ? 
              `<button class="leave-btn" onclick="leaveGroup('${currentSection}', ${groupIndex})">Leave</button>` : '';
          
            const symbol = player.type === 'guild' ? 'âœ” ' : player.type === 'merc' ? 'âœ¦ ' : '';
            const photoURL = (window.allUserPhotos && window.allUserPhotos[player.name]) || null;

            playerListHTML += `
              <li class="player-${player.type}" 
                  data-original-name="${symbol}${player.name}"
                  style="display: flex; align-items: center; justify-content: space-between;"
                  ${currentUser && ['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role) ? 'draggable="true"' : ''}>
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                  ${photoURL ? `<img src="${photoURL}" alt="avatar" style="width:24px;height:24px;border-radius:50%;">` : ''}
                  <span>
                    ${symbol}${player.name}
                    ${window.allUserRoles && getRoleBadgeImage(window.allUserRoles[player.name]) 
                      ? `<img src="${getRoleBadgeImage(window.allUserRoles[player.name])}" alt="${window.allUserRoles[player.name]}" style="width: 20px; height: 20px; vertical-align: middle; margin-left: 5px;">`
                      : ''}
                  </span>
                </div>
                ${leaveButton}
              </li>
            `;
          } else {
            // Empty slot with the option to join
            const joinButton = currentUser && canJoinGroup(group) ?
              `<button class="join-btn" onclick="joinGroup('${currentSection}', ${groupIndex})">Join</button>` : '';
          
            playerListHTML += `
              <li data-empty-slot="true">
                <span>- empty -</span>
                ${joinButton}
              </li>
            `;
          }
        }
    
        // Admin/Officer edit button
        const editButton = currentUser && ['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role) ?
          `<button class="btn btn-secondary" style="font-size: 0.8rem; padding: 0.3rem 0.7rem;" onclick="editGroup('${currentSection}', ${groupIndex})">Edit</button>` : '';
    
        // Convert UTC time to local time
        const localTime = convertUTCToLocal(group.timeUTC);
        const groupDate = group.dateLabel ? `<div class="timezone">ðŸ“… ${group.dateLabel}</div>` : '';
    
        div.innerHTML = `
          <h2>${group.group} ${editButton}</h2>
          <div class="timezone">${localTime}</div>
          ${groupDate}

          <ul class="player-list">
            ${playerListHTML}
          </ul>
        `;
        container.appendChild(div);
      });

      // Enable drag and drop for authorized users
      if (currentUser && ['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) {
        enableDragAndDrop();
      }
    }

    // Function to edit a group (for admins/officers)
    function editGroup(section, groupIndex) {
        if (!currentUser || !['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) {
            return;
        }
    
        // Handle rerun section name mapping
        const actualSection = section === 'rerun' ? 'reruns' : section;
        const group = allData[actualSection][groupIndex];
        if (!group) return;

        // Fill the form with group data
        document.getElementById('editGroupName').value = group.group || '';
        document.getElementById('editGroupTime').value = group.timeUTC || '';
        document.getElementById('editGroupDate').value = group.dateLabel || '';

        // Fill member list
        const membersContainer = document.getElementById('editGroupMembers');
        membersContainer.innerHTML = '';
    
        for (let i = 0; i < 5; i++) {
            const playerName = group.players[i] || '';
        
            const memberInput = document.createElement('div');
            memberInput.className = 'form-group';
            memberInput.style.marginBottom = '0.5rem';
            memberInput.innerHTML = `
                <input type="text" id="editMember${i}" value="${playerName}" placeholder="Empty slot">
            `;
        
            membersContainer.appendChild(memberInput);
        }
    
        // Set up the save button
        document.getElementById('saveGroupChangesBtn').onclick = function() {
            saveGroupChanges(actualSection, groupIndex);
        };
    
        // Open the modal
        openModal('editGroupModal');
    }

    // Function to save group changes
    async function saveGroupChanges(section, groupIndex) {
        if (!currentUser || !['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) {
            return;
        }
    
        // Handle section name mapping (important for re-runs)
        const actualSection = section === 'rerun' ? 'reruns' : section;
        const group = allData[actualSection][groupIndex];
        if (!group) return;

        // Get values from form
        group.group = document.getElementById('editGroupName').value.trim();
        group.timeUTC = document.getElementById('editGroupTime').value.trim();
        group.dateLabel = document.getElementById('editGroupDate').value.trim();
    
        // Get member list
        group.players = [];
        for (let i = 0; i < 5; i++) {
            const memberInput = document.getElementById(`editMember${i}`);
            group.players.push(memberInput.value.trim());
        }
    
        // Save to Firebase using the correct section name
        await database.ref(`roster/${actualSection}/${groupIndex}`).set(group);
    
        // Re-render using the current view section (not the internal section name)
        renderGroups(allData[getActualSection(currentSection)]);
    
        // Close the modal
        closeModal('editGroupModal');
    }

	// Function to set active section
	function setSection(section) {
	  // Set current section for tracking
	  currentSection = section;
	  
	  // Update UI to show active button
	  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
	  document.getElementById(`btn-${section}`).classList.add('active');
	  
	  // Map 'rerun' to 'reruns' in the data structure
	  const dataSection = section === 'rerun' ? 'reruns' : section;
	  
	  // Check if we have data for this section
	  if (allData[dataSection] && Array.isArray(allData[dataSection])) {
		renderGroups(allData[dataSection]);
	  } else {
		console.error(`No valid data for section: ${dataSection}`);
		document.getElementById('roster').innerHTML = '<div class="loading">No data available for this section.</div>';
	  }
	}

	// Function to fetch all data from Firebase
	async function fetchAllData() {
	  document.getElementById('roster').innerHTML = '<div class="loading">Loading roster data...</div>';
	  
	  try {
		console.log("Fetching roster data...");
		const snapshot = await database.ref('roster').once('value');
		const data = snapshot.val();
		
		console.log("Roster data received:", data);
		
		if (!data) {
		  console.warn("No roster data found");
		  document.getElementById('roster').innerHTML = '<div class="loading">No roster data found. Please check back later or contact an administrator.</div>';
		  return;
		}
		
		// Ensure we have arrays for each section
		allData.normal = Array.isArray(data.normal) ? data.normal : [];
		allData.hard = Array.isArray(data.hard) ? data.hard : [];
		allData.reruns = Array.isArray(data.reruns) ? data.reruns : [];
		
		console.log("Data processed:", allData);
		
		// Update the last fetched time
		const now = new Date();
		document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
		
		// Render the active section (use correct section name mapping)
		const dataSection = currentSection === 'rerun' ? 'reruns' : currentSection;
		renderGroups(allData[dataSection]);
		
		// Set up realtime listener
		database.ref('roster').on('value', (snapshot) => {
		  const updatedData = snapshot.val();
		  if (!updatedData) return;
		  
		  console.log("Real-time update received:", updatedData);
		  
		  allData.normal = Array.isArray(updatedData.normal) ? updatedData.normal : [];
		  allData.hard = Array.isArray(updatedData.hard) ? updatedData.hard : [];
		  allData.reruns = Array.isArray(updatedData.reruns) ? updatedData.reruns : [];
		  
		  // Use the correct section mapping when rendering
		  const dataSection = currentSection === 'rerun' ? 'reruns' : currentSection;
		  renderGroups(allData[dataSection]);
		});
	  } catch (error) {
		console.error('Error fetching data:', error);
		document.getElementById('roster').innerHTML = `<div class="loading">Error loading roster data: ${error.message}</div>`;
		document.getElementById('lastUpdated').textContent = `Error: ${error.message}`;
	  }
	}
	
	// Enables SortableJS on all lists with swap behavior
	function enableDragAndDrop() {
	  const lists = document.querySelectorAll('.player-list');
	  
	  // Add hover effect styles dynamically
	  const style = document.createElement('style');
	  style.textContent = `
	    .player-list li.sortable-ghost {
	      background-color: rgba(61, 132, 247, 0.3) !important;
	    }
	    .player-list li.highlight-drop {
	      background-color: rgba(61, 132, 247, 0.5) !important;
	      transform: scale(1.02);
	      transition: all 0.2s ease;
	    }
	    .player-list li[draggable="true"] {
	      cursor: grab;
	    }
	    .player-list li[draggable="true"]:active {
	      cursor: grabbing;
	    }
	  `;
	  document.head.appendChild(style);
	
	  lists.forEach((list) => {
	    new Sortable(list, {
	      group: 'shared',
	      animation: 150,
	      ghostClass: 'sortable-ghost',
	      dragClass: 'sortable-drag',
	      swap: true,
	      swapClass: 'highlight-drop',
	      invertSwap: true,
	      dragCursor: 'grab',
	      onStart: function(evt) {
	        evt.item.classList.add('dragging');
	      },
	      onEnd: function(evt) {
	        evt.item.classList.remove('dragging');
	        saveDragChanges(); // Save changes immediately after drag ends
	      },
	      onChoose: function(evt) {
	        evt.item.style.opacity = '0.5';
	      },
	      onUnchoose: function(evt) {
	        evt.item.style.opacity = '';
	      }
	    });
	  });
	
	  // Set up drop targets for player slots
	  setupPlayerSlotDropTargets();
	}

	async function saveDragChanges() {
	  const sectionName = currentSection === 'rerun' ? 'reruns' : currentSection;
	  const groups = document.querySelectorAll('.group');
	
	  for (let i = 0; i < groups.length; i++) {
	    const listItems = groups[i].querySelectorAll('.player-list li');
	    const newPlayers = [];
	
	    listItems.forEach(li => {
	      if (li.hasAttribute('data-empty-slot')) {
	        newPlayers.push('');
	        return;
	      }
	
	      let rawName = li.dataset.originalName || 
	                   (li.querySelector('span') ? li.querySelector('span').textContent.trim() : '');
	
	      if (!rawName || rawName === '- empty -') {
	        newPlayers.push('');
	      } else {
	        const symbol = rawName.includes('âœ¦') ? 'âœ¦ ' : 'âœ” ';
	        const cleanedName = rawName.replace(/^âœ”\s*|^âœ¦\s*/, '').trim();
	        newPlayers.push(symbol + cleanedName);
	      }
	    });
	
	    while (newPlayers.length < 5) {
	      newPlayers.push('');
	    }
	
	    allData[sectionName][i].players = newPlayers;
	    await database.ref(`roster/${sectionName}/${i}`).set(allData[sectionName][i]);
	  }
	  
	  // No alert here - changes save silently
	}
	  
	// Function to load and display all users
	async function loadAllUsers() {
	  try {
	    const snapshot = await database.ref('users').once('value');
	    const users = snapshot.val() || {};
	    const userList = document.getElementById('userList');
	    
	    if (Object.keys(users).length === 0) {
	      userList.innerHTML = '<div class="loading">No users found</div>';
	      return;
	    }
	    
	    userList.innerHTML = '';
	    
	    // Convert to array and sort alphabetically
	    const userArray = Object.values(users)
	      .filter(user => user.username) // Only include users with usernames
	      .sort((a, b) => a.username.localeCompare(b.username));
	    
	    userArray.forEach(user => {
	      const userItem = document.createElement('div');
	      userItem.className = 'user-list-item';
	      
	      // Make item draggable only for admins/officers
	      if (currentUser && ['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) {
	        userItem.draggable = true;
	        userItem.style.cursor = 'grab';
	        userItem.addEventListener('dragstart', handleUserDragStart);
	      }
	      
	      const avatarUrl = user.photoURL || '';
	      const roleBadge = getRoleBadgeImage(user.role);
	      
	      userItem.innerHTML = `
	        ${avatarUrl ? `<img src="${avatarUrl}" class="user-list-avatar" alt="${user.username}">` : 
	          `<div class="user-list-avatar" style="background-color: ${stringToColor(user.username)}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.username.charAt(0).toUpperCase()}</div>`}
	        <span class="user-list-name">${user.username}</span>
	        ${roleBadge ? `<img src="${roleBadge}" class="user-list-role" alt="${user.role}" style="width: 24px; height: 24px;">` : ''}
	      `;
	      
	      // Store user data on the element
	      userItem.dataset.username = user.username;
	      userItem.dataset.role = user.role;
	      
	      userList.appendChild(userItem);
	    });
	    
	    // Rest of the function remains the same...
	    // Set up realtime updates
	    database.ref('users').on('value', (snapshot) => {
	      const updatedUsers = snapshot.val() || {};
	      const updatedList = document.getElementById('userList');
	      updatedList.innerHTML = '';
	      
	      const updatedArray = Object.values(updatedUsers)
	        .filter(user => user.username)
	        .sort((a, b) => a.username.localeCompare(b.username));
	      
	      updatedArray.forEach(user => {
	        const userItem = document.createElement('div');
	        userItem.className = 'user-list-item';
	        
	        // Make item draggable only for admins/officers
	        if (currentUser && ['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) {
	          userItem.draggable = true;
	          userItem.style.cursor = 'grab';
	          userItem.addEventListener('dragstart', handleUserDragStart);
	        }
	        
	        const avatarUrl = user.photoURL || '';
	        const roleBadge = getRoleBadgeImage(user.role);
	        
	        userItem.innerHTML = `
	          ${avatarUrl ? `<img src="${avatarUrl}" class="user-list-avatar" alt="${user.username}">` : 
	            `<div class="user-list-avatar" style="background-color: ${stringToColor(user.username)}; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">${user.username.charAt(0).toUpperCase()}</div>`}
	          <span class="user-list-name">${user.username}</span>
	          ${roleBadge ? `<img src="${roleBadge}" class="user-list-role" alt="${user.role}" style="width: 24px; height: 24px;">` : ''}
	        `;
	        
	        // Store user data on the element
	        userItem.dataset.username = user.username;
	        userItem.dataset.role = user.role;
	        
	        updatedList.appendChild(userItem);
	      });
	    });
	    
	  } catch (error) {
	    console.error('Error loading users:', error);
	    document.getElementById('userList').innerHTML = `<div class="loading">Error loading users: ${error.message}</div>`;
	  }
	}

	// Handle drag start from user list
	function handleUserDragStart(e) {
	  // Get the list item being dragged
	  const listItem = e.target.closest('.user-list-item');
	  if (!listItem) return;
	
	  // Get clean username (remove any existing symbols)
	  const username = listItem.dataset.username || 
	                 listItem.textContent.replace(/^[âœ”âœ¦]\s*/, '').trim();
	
	  // Determine role from data attribute or symbol
	  const role = listItem.dataset.role || 
	              (listItem.textContent.includes('âœ¦') ? 'mercenary' : 'member');
	
	  // Set the drag data in the original format
	  e.dataTransfer.setData('text/plain', JSON.stringify({
	    username: username,
	    role: role
	  }));
	  
	  e.dataTransfer.effectAllowed = 'copy';
	
	  // Drag image code
	  const dragImage = e.target.cloneNode(true);
	  dragImage.style.position = 'absolute';
	  dragImage.style.top = '-9999px';
	  document.body.appendChild(dragImage);
	  e.dataTransfer.setDragImage(dragImage, 0, 0);
	  
	  setTimeout(() => document.body.removeChild(dragImage), 0);
	}
	
	// Set up drop targets on player slots
	function setupPlayerSlotDropTargets() {
	  const playerSlots = document.querySelectorAll('.player-list li');
	  
	  playerSlots.forEach(slot => {
	    // Only make slots droppable if user has permission
	    if (currentUser && ['admin', 'guild-master', 'advisor', 'staff', 'officer'].includes(currentUser.role)) {
	      slot.addEventListener('dragover', handleSlotDragOver);
	      slot.addEventListener('dragenter', handleSlotDragEnter);
	      slot.addEventListener('dragleave', handleSlotDragLeave);
	      slot.addEventListener('drop', handleSlotDrop);
	      slot.addEventListener('dragend', handleSlotDragEnd);
	    }
	  });
	}
	
	function handleSlotDragOver(e) {
	  e.preventDefault();
	  e.dataTransfer.dropEffect = 'copy';
	}
	
	function handleSlotDragEnter(e) {
	  e.preventDefault();
	  e.target.classList.add('highlight-drop');
	}
	
	function handleSlotDragLeave(e) {
	  e.preventDefault();
	  e.target.classList.remove('highlight-drop');
	}
	
	function handleSlotDragEnd(e) {
	  e.preventDefault();
	  document.querySelectorAll('.player-list li').forEach(slot => {
	    slot.classList.remove('highlight-drop');
	  });
	}
	
	async function handleSlotDrop(e) {
	  e.preventDefault();
	  e.target.classList.remove('highlight-drop');
	
	  try {
	    const data = JSON.parse(e.dataTransfer.getData('text/plain'));
	    if (!data.username) return;
	
	    const groupElement = e.target.closest('.group');
	    if (!groupElement) return;
	    
	    const groupIndex = Array.from(document.querySelectorAll('.group')).indexOf(groupElement);
	    const slotIndex = Array.from(e.target.parentNode.children).indexOf(e.target);
	
	    const symbol = data.role === 'mercenary' ? 'âœ¦ ' : 'âœ” ';
	    const playerName = symbol + data.username;
	
	    const sectionName = currentSection === 'rerun' ? 'reruns' : currentSection;
	    allData[sectionName][groupIndex].players[slotIndex] = playerName;
	
	    await database.ref(`roster/${sectionName}/${groupIndex}`).set(allData[sectionName][groupIndex]);
	    renderGroups(allData[sectionName]);
	  } catch (error) {
	    console.debug('Drag operation completed');
	  }
	}
	
	// Helper function to generate a color from a string
	function stringToColor(str) {
	  let hash = 0;
	  for (let i = 0; i < str.length; i++) {
	    hash = str.charCodeAt(i) + ((hash << 5) - hash);
	  }
	  let color = '#';
	  for (let i = 0; i < 3; i++) {
	    const value = (hash >> (i * 8)) & 0xFF;
	    color += ('00' + value.toString(16)).substr(-2);
	  }
	  return color;
	}
	  
    // Initial load
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>